<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug API Strapi | PropInvest</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 12px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    .field-list {
      background: #e9ecef;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Debug API Strapi</h1>
    <p>Esta p√°gina te ayudar√° a diagnosticar problemas con la API de Strapi.</p>
    
    <div id="status-container">
      <div class="status info">
        <strong>Estado:</strong> Listo para diagnosticar...
      </div>
    </div>
    
    <div style="margin: 20px 0;">
      <button onclick="testBasicAPI()">üîó Probar API B√°sica</button>
      <button onclick="testAllProperties()">üìã Ver Todas las Propiedades</button>
      <button onclick="testPublishedProperties()">‚úÖ Ver Propiedades Publicadas</button>
      <button onclick="testFeaturedProperties()">‚≠ê Ver Propiedades Destacadas</button>
    </div>
    
    <div id="results">
      <div style="text-align: center; padding: 20px; color: #666;">
        Haz clic en "Probar API B√°sica" para comenzar
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://truthful-rhythm-e8bcafa766.strapiapp.com/api';
    const statusContainer = document.getElementById('status-container');
    const resultsContainer = document.getElementById('results');

    function updateStatus(message, type = 'info') {
      statusContainer.innerHTML = `
        <div class="status ${type}">
          <strong>Estado:</strong> ${message}
        </div>
      `;
    }

    function showResults(content) {
      resultsContainer.innerHTML = content;
    }

    async function testBasicAPI() {
      updateStatus('Probando API b√°sica...', 'info');
      
      try {
        const response = await fetch(`${API_BASE}/propiedads`);
        const data = await response.json();
        
        if (data && data.data) {
          updateStatus(`‚úÖ API funciona! Encontradas ${data.data.length} propiedades`, 'success');
          
          const fields = data.data.length > 0 ? Object.keys(data.data[0].attributes) : [];
          
          showResults(`
            <div class="status success">
              <h3>‚úÖ Conexi√≥n exitosa</h3>
              <p><strong>Total de propiedades:</strong> ${data.data.length}</p>
              <p><strong>Campos disponibles:</strong></p>
              <div class="field-list">
                ${fields.map(field => `<code>${field}</code>`).join(', ')}
              </div>
            </div>
            <h3>Datos completos:</h3>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `);
        } else {
          throw new Error('Respuesta inesperada de la API');
        }
      } catch (error) {
        updateStatus(`‚ùå Error: ${error.message}`, 'error');
        showResults(`
          <div class="status error">
            <h3>‚ùå Error de conexi√≥n</h3>
            <p><strong>Error:</strong> ${error.message}</p>
            <p><strong>URL probada:</strong> ${API_BASE}/propiedads</p>
          </div>
        `);
      }
    }

    async function testAllProperties() {
      updateStatus('Cargando todas las propiedades...', 'info');
      
      try {
        const response = await fetch(`${API_BASE}/propiedads?populate=*`);
        const data = await response.json();
        
        if (data && data.data) {
          updateStatus(`‚úÖ Se cargaron ${data.data.length} propiedades`, 'success');
          
          const propertiesHTML = data.data.map(prop => {
            const attrs = prop.attributes;
            const fields = Object.keys(attrs);
            
            return `
              <div class="status info" style="margin: 15px 0;">
                <h4>üè† ${attrs.Titulo || 'Sin t√≠tulo'}</h4>
                <p><strong>ID:</strong> ${prop.id}</p>
                <p><strong>Slug:</strong> ${attrs.Slug || 'Sin slug'}</p>
                <p><strong>Campos disponibles:</strong></p>
                <div class="field-list">
                  ${fields.map(field => `<code>${field}</code>`).join(', ')}
                </div>
                <details>
                  <summary>Ver datos completos</summary>
                  <pre>${JSON.stringify(attrs, null, 2)}</pre>
                </details>
              </div>
            `;
          }).join('');
          
          showResults(propertiesHTML);
        } else {
          throw new Error('No se pudieron cargar las propiedades');
        }
      } catch (error) {
        updateStatus(`‚ùå Error: ${error.message}`, 'error');
        showResults(`
          <div class="status error">
            <h3>‚ùå Error al cargar propiedades</h3>
            <p><strong>Error:</strong> ${error.message}</p>
          </div>
        `);
      }
    }

    async function testPublishedProperties() {
      updateStatus('Probando filtro de propiedades publicadas...', 'info');
      
      try {
        // Primero probamos sin filtro para ver qu√© campos existen
        const response = await fetch(`${API_BASE}/propiedads?populate=*`);
        const data = await response.json();
        
        if (data && data.data && data.data.length > 0) {
          const firstProp = data.data[0];
          const fields = Object.keys(firstProp.attributes);
          
          // Verificar si existe el campo 'publicado'
          const hasPublishedField = fields.includes('publicado');
          
          if (hasPublishedField) {
            // Si existe, probamos el filtro
            const publishedResponse = await fetch(`${API_BASE}/propiedads?filters[publicado][$eq]=true&populate=*`);
            const publishedData = await publishedResponse.json();
            
            updateStatus(`‚úÖ Campo 'publicado' existe. Encontradas ${publishedData.data?.length || 0} propiedades publicadas`, 'success');
            
            showResults(`
              <div class="status success">
                <h3>‚úÖ Campo 'publicado' encontrado</h3>
                <p><strong>Propiedades publicadas:</strong> ${publishedData.data?.length || 0}</p>
                <p><strong>Campos disponibles:</strong> ${fields.join(', ')}</p>
              </div>
              <h3>Propiedades publicadas:</h3>
              <pre>${JSON.stringify(publishedData, null, 2)}</pre>
            `);
          } else {
            updateStatus(`‚ö†Ô∏è Campo 'publicado' NO existe. Campos disponibles: ${fields.join(', ')}`, 'warning');
            
            showResults(`
              <div class="status warning">
                <h3>‚ö†Ô∏è Campo 'publicado' no encontrado</h3>
                <p><strong>Campos disponibles:</strong> ${fields.join(', ')}</p>
                <p><strong>Recomendaci√≥n:</strong> Agrega el campo 'publicado' (Boolean) a tu colecci√≥n en Strapi</p>
              </div>
              <h3>Todas las propiedades (sin filtro):</h3>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            `);
          }
        } else {
          throw new Error('No hay propiedades para analizar');
        }
      } catch (error) {
        updateStatus(`‚ùå Error: ${error.message}`, 'error');
        showResults(`
          <div class="status error">
            <h3>‚ùå Error al verificar propiedades publicadas</h3>
            <p><strong>Error:</strong> ${error.message}</p>
          </div>
        `);
      }
    }

    async function testFeaturedProperties() {
      updateStatus('Probando filtro de propiedades destacadas...', 'info');
      
      try {
        const response = await fetch(`${API_BASE}/propiedads?populate=*`);
        const data = await response.json();
        
        if (data && data.data && data.data.length > 0) {
          const firstProp = data.data[0];
          const fields = Object.keys(firstProp.attributes);
          
          const hasFeaturedField = fields.includes('destacado');
          
          if (hasFeaturedField) {
            const featuredResponse = await fetch(`${API_BASE}/propiedads?filters[destacado][$eq]=true&populate=*`);
            const featuredData = await featuredResponse.json();
            
            updateStatus(`‚úÖ Campo 'destacado' existe. Encontradas ${featuredData.data?.length || 0} propiedades destacadas`, 'success');
            
            showResults(`
              <div class="status success">
                <h3>‚úÖ Campo 'destacado' encontrado</h3>
                <p><strong>Propiedades destacadas:</strong> ${featuredData.data?.length || 0}</p>
              </div>
              <h3>Propiedades destacadas:</h3>
              <pre>${JSON.stringify(featuredData, null, 2)}</pre>
            `);
          } else {
            updateStatus(`‚ö†Ô∏è Campo 'destacado' NO existe. Campos disponibles: ${fields.join(', ')}`, 'warning');
            
            showResults(`
              <div class="status warning">
                <h3>‚ö†Ô∏è Campo 'destacado' no encontrado</h3>
                <p><strong>Campos disponibles:</strong> ${fields.join(', ')}</p>
                <p><strong>Recomendaci√≥n:</strong> Agrega el campo 'destacado' (Boolean) a tu colecci√≥n en Strapi</p>
              </div>
            `);
          }
        } else {
          throw new Error('No hay propiedades para analizar');
        }
      } catch (error) {
        updateStatus(`‚ùå Error: ${error.message}`, 'error');
        showResults(`
          <div class="status error">
            <h3>‚ùå Error al verificar propiedades destacadas</h3>
            <p><strong>Error:</strong> ${error.message}</p>
          </div>
        `);
      }
    }

    // Auto-probar al cargar la p√°gina
    window.addEventListener('load', () => {
      setTimeout(testBasicAPI, 1000);
    });
  </script>
</body>
</html> 