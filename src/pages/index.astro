---
import Layout from '../layouts/Layout.astro';

// Inicializamos las variables como arreglos vacíos por seguridad
let propiedadesVenta = [];
let propiedadesArriendo = [];

try {
  const API_URL = 'https://truthful-rhythm-e8bcafa766.strapiapp.com/api';
  const response = await fetch(`${API_URL}/propiedads?populate=*&filters[Destacado][$eq]=true&filters[Publicado][$eq]=true`);
  
  if (response.ok) {
    const { data: todasDestacadas } = await response.json();

    // SOLUCIÓN: Verificamos que 'todasDestacadas' sea un arreglo antes de filtrarlo.
    // Si la API no devuelve nada o hay un error, no se caerá la página.
    if (Array.isArray(todasDestacadas)) {
      propiedadesVenta = todasDestacadas.filter(p => p && p.attributes && p.attributes.Objetivo === 'Venta');
      propiedadesArriendo = todasDestacadas.filter(p => p && p.attributes && p.attributes.Objetivo === 'Arriendo');
    }
  } else {
    // Si la respuesta de la API no es exitosa, lo mostramos en la consola del servidor
    console.error('Error al obtener propiedades destacadas:', response.statusText);
  }
} catch (error) {
  // Si hay un error de red o de otro tipo, también lo capturamos
  console.error('Error en el fetch de propiedades destacadas:', error);
}
---
<Layout
  title="PropInvest | Propiedades que definen un legado"
  description="Propiedades exclusivas y de lujo en Chile. Descubre tu próxima inversión inmobiliaria con PropInvest."
>
  {/* Este script es necesario para que los carruseles funcionen en esta página */}
  <script is:inline src="/assets/js/featured-carousel.js"></script>

  <main>
    <section class="hero">
      <div class="hero-content">
        <h1 class="hero-title">Propiedades que definen un legado</h1>
        <p class="hero-subtitle">Inversiones inmobiliarias exclusivas para quienes buscan lo extraordinario.</p>
        <a href="/propiedades" class="cta">Ver Propiedades</a>
      </div>
    </section>

    <section class="container" style="margin-top:3rem;">
      <div class="section-title">¿Por qué elegir PropInvest?</div>
      <div class="section-subtitle">Experiencia, confianza y una selección inigualable de propiedades de lujo.</div>
      <div style="display: flex; flex-wrap: wrap; gap:2rem; justify-content:center;">
        <div class="info-box" style="max-width:340px;">
          <div class="info-icon">🏆</div>
          <div class="info-content">
            <div class="info-title">Trayectoria comprobada</div>
            <div class="info-text">Más de 15 años asesorando a clientes de alto patrimonio en inversiones inmobiliarias.</div>
          </div>
        </div>
        <div class="info-box" style="max-width:340px;">
          <div class="info-icon">🔒</div>
          <div class="info-content">
            <div class="info-title">Confidencialidad y seguridad</div>
            <div class="info-text">Procesos discretos y seguros para proteger tu inversión y privacidad.</div>
          </div>
        </div>
        <div class="info-box" style="max-width:340px;">
          <div class="info-icon">🌎</div>
          <div class="info-content">
            <div class="info-title">Red internacional</div>
            <div class="info-text">Acceso a oportunidades exclusivas en Chile y el extranjero.</div>
          </div>
        </div>
      </div>
    </section>

    <section class="container" style="margin-top:4rem;">
      <div class="section-title">Propiedades Destacadas en Venta</div>
      <div class="section-subtitle">Descubre una selección de residencias únicas y exclusivas en venta.</div>
      <div class="featured-properties-carousel">
        {/* El carrusel se llenará con JavaScript */}
      </div>
    </section>

    <section class="container" style="margin-top:4rem;">
      <div class="section-title">Propiedades Destacadas en Arriendo</div>
      <div class="section-subtitle">Descubre residencias exclusivas disponibles para arriendo.</div>
      <div class="featured-rental-properties-carousel">
        {/* El carrusel se llenará con JavaScript */}
      </div>
    </section>

    <section class="container" style="margin-bottom:4rem;">
      <div class="section-title">Lo que dicen nuestros clientes</div>
      <div class="section-subtitle">Experiencias reales de quienes confiaron en PropInvest</div>
      <div style="display:flex; flex-wrap:wrap; gap:2.5rem; justify-content:center;">
        <div class="testimonial-card">
          <img src="/assets/images/agent-1.jpg" alt="Foto cliente satisfecho" class="testimonial-photo" />
          <div class="testimonial-name">María P.</div>
          <div class="testimonial-text">"La atención fue personalizada y el proceso, impecable. Encontré la casa de mis sueños."</div>
        </div>
        <div class="testimonial-card">
          <img src="/assets/images/agent-1.jpg" alt="Foto cliente satisfecho" class="testimonial-photo" />
          <div class="testimonial-name">Carlos D.</div>
          <div class="testimonial-text">"PropInvest me ayudó a invertir de forma segura y con total confidencialidad."</div>
        </div>
      </div>
    </section>
  </main>

  <script define:vars={{ propiedadesVenta, propiedadesArriendo }}>
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof cargarPropiedadesDestacadasCarousel === 'function') {
        cargarPropiedadesDestacadasCarousel('.featured-properties-carousel', propiedadesVenta);
      }
      if (typeof cargarPropiedadesDestacadasArriendoCarousel === 'function') {
        cargarPropiedadesDestacadasArriendoCarousel('.featured-rental-properties-carousel', propiedadesArriendo);
      }
    });
  </script>
</Layout>