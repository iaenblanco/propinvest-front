---
import Layout from '../layouts/Layout.astro';

// Inicializamos las variables como arreglos vac√≠os por seguridad
let propiedadesVenta = [];
let propiedadesArriendo = [];

try {
  const API_URL = 'https://truthful-rhythm-e8bcafa766.strapiapp.com/api';
  const response = await fetch(`${API_URL}/propiedads?populate=*&filters[Destacado][$eq]=true&filters[Publicado][$eq]=true`);
  
  if (response.ok) {
    const { data: todasDestacadas } = await response.json();

    console.log('üì¶ Propiedades destacadas obtenidas:', todasDestacadas?.length || 0);

    // Verificamos que 'todasDestacadas' sea un arreglo antes de filtrarlo
    if (Array.isArray(todasDestacadas)) {
      // AGREGAMOS LOGS DETALLADOS PARA VER LOS DATOS
      console.log('üîç Investigando datos de Strapi:');
      todasDestacadas.forEach((prop, index) => {
        console.log(`   Propiedad ${index + 1}:`, {
          id: prop.id,
          titulo: prop.attributes?.Titulo,
          objetivo: prop.attributes?.Objetivo,
          objetivoType: typeof prop.attributes?.Objetivo,
          destacado: prop.attributes?.Destacado,
          publicado: prop.attributes?.Publicado
        });
      });

      const propiedadesVentaBruto = todasDestacadas.filter(p => {
        const objetivo = p?.attributes?.Objetivo;
        console.log(`üîç Filtrando venta - Objetivo: "${objetivo}" (tipo: ${typeof objetivo})`);
        return p && p.attributes && objetivo === 'Venta';
      });
      
      const propiedadesArriendoBruto = todasDestacadas.filter(p => {
        const objetivo = p?.attributes?.Objetivo;
        console.log(`üîç Filtrando arriendo - Objetivo: "${objetivo}" (tipo: ${typeof objetivo})`);
        return p && p.attributes && objetivo === 'Arriendo';
      });
      
      console.log('üè† Propiedades venta encontradas:', propiedadesVentaBruto.length);
      console.log('üèòÔ∏è Propiedades arriendo encontradas:', propiedadesArriendoBruto.length);
      
      // Transformar datos de Strapi al formato que espera el carrusel
      propiedadesVenta = propiedadesVentaBruto.map(prop => {
        const attrs = prop.attributes;
        return {
          id: prop.id,
          Titulo: attrs.Titulo,
          Slug: attrs.Slug,
          Precio: attrs.Precio,
          Ubicacion: attrs.Ubicacion,
          Dormitorios: attrs.Dormitorios,
          Banos: attrs.Banos,
          Superficie: attrs.Superficie,
          Objetivo: attrs.Objetivo,
          Destacado: attrs.Destacado,
          Imagenes: attrs.Imagenes?.data?.map(img => ({
            url: img.attributes.url.startsWith('http') 
              ? img.attributes.url 
              : `https://truthful-rhythm-e8bcafa766.strapiapp.com${img.attributes.url}`
          })) || []
        };
      });
      
      propiedadesArriendo = propiedadesArriendoBruto.map(prop => {
        const attrs = prop.attributes;
        return {
          id: prop.id,
          Titulo: attrs.Titulo,
          Slug: attrs.Slug,
          Precio: attrs.Precio,
          Ubicacion: attrs.Ubicacion,
          Dormitorios: attrs.Dormitorios,
          Banos: attrs.Banos,
          Superficie: attrs.Superficie,
          Objetivo: attrs.Objetivo,
          Destacado: attrs.Destacado,
          Imagenes: attrs.Imagenes?.data?.map(img => ({
            url: img.attributes.url.startsWith('http') 
              ? img.attributes.url 
              : `https://truthful-rhythm-e8bcafa766.strapiapp.com${img.attributes.url}`
          })) || []
        };
      });
      
      console.log('‚úÖ Propiedades transformadas - Venta:', propiedadesVenta.length, 'Arriendo:', propiedadesArriendo.length);
    }
  } else {
    console.error('‚ùå Error al obtener propiedades destacadas:', response.statusText);
  }
} catch (error) {
  console.error('‚ùå Error en el fetch de propiedades destacadas:', error);
}
---
<Layout
  title="PropInvest | Propiedades que definen un legado"
  description="Propiedades exclusivas y de lujo en Chile. Descubre tu pr√≥xima inversi√≥n inmobiliaria con PropInvest."
>
  {/* Este script es necesario para que los carruseles funcionen en esta p√°gina */}
  <script is:inline src="/assets/js/featured-carousel.js"></script>

  <main>
    <section class="hero">
      <div class="hero-content">
        <h1 class="hero-title">Propiedades que definen un legado</h1>
        <p class="hero-subtitle">Inversiones inmobiliarias exclusivas para quienes buscan lo extraordinario.</p>
        <a href="/propiedades" class="cta">Ver Propiedades</a>
      </div>
    </section>

    <section class="container" style="margin-top:3rem;">
      <div class="section-title">¬øPor qu√© elegir PropInvest?</div>
      <div class="section-subtitle">Experiencia, confianza y una selecci√≥n inigualable de propiedades de lujo.</div>
      <div style="display: flex; flex-wrap: wrap; gap:2rem; justify-content:center;">
        <div class="info-box" style="max-width:340px;">
          <div class="info-icon">üèÜ</div>
          <div class="info-content">
            <div class="info-title">Trayectoria comprobada</div>
            <div class="info-text">M√°s de 15 a√±os asesorando a clientes de alto patrimonio en inversiones inmobiliarias.</div>
          </div>
        </div>
        <div class="info-box" style="max-width:340px;">
          <div class="info-icon">üîí</div>
          <div class="info-content">
            <div class="info-title">Confidencialidad y seguridad</div>
            <div class="info-text">Procesos discretos y seguros para proteger tu inversi√≥n y privacidad.</div>
          </div>
        </div>
        <div class="info-box" style="max-width:340px;">
          <div class="info-icon">üåé</div>
          <div class="info-content">
            <div class="info-title">Red internacional</div>
            <div class="info-text">Acceso a oportunidades exclusivas en Chile y el extranjero.</div>
          </div>
        </div>
      </div>
    </section>

    <section class="container" style="margin-top:4rem;">
      <div class="section-title">Propiedades Destacadas en Venta</div>
      <div class="section-subtitle">Descubre una selecci√≥n de residencias √∫nicas y exclusivas en venta.</div>
      <div class="featured-properties-carousel">
        {/* El carrusel se llenar√° con JavaScript */}
      </div>
    </section>

    <section class="container" style="margin-top:4rem;">
      <div class="section-title">Propiedades Destacadas en Arriendo</div>
      <div class="section-subtitle">Descubre residencias exclusivas disponibles para arriendo.</div>
      <div class="featured-rental-properties-carousel">
        {/* El carrusel se llenar√° con JavaScript */}
      </div>
    </section>

    <section class="container" style="margin-bottom:4rem;">
      <div class="section-title">Lo que dicen nuestros clientes</div>
      <div class="section-subtitle">Experiencias reales de quienes confiaron en PropInvest</div>
      <div style="display:flex; flex-wrap:wrap; gap:2.5rem; justify-content:center;">
        <div class="testimonial-card">
          <img src="/assets/images/agent-1.jpg" alt="Foto cliente satisfecho" class="testimonial-photo" />
          <div class="testimonial-name">Mar√≠a P.</div>
          <div class="testimonial-text">"La atenci√≥n fue personalizada y el proceso, impecable. Encontr√© la casa de mis sue√±os."</div>
        </div>
        <div class="testimonial-card">
          <img src="/assets/images/agent-1.jpg" alt="Foto cliente satisfecho" class="testimonial-photo" />
          <div class="testimonial-name">Carlos D.</div>
          <div class="testimonial-text">"PropInvest me ayud√≥ a invertir de forma segura y con total confidencialidad."</div>
        </div>
      </div>
    </section>
  </main>

  <script define:vars={{ propiedadesVenta, propiedadesArriendo }}>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üé† Datos recibidos en cliente:');
      console.log('   - Propiedades venta:', propiedadesVenta?.length || 0);
      console.log('   - Propiedades arriendo:', propiedadesArriendo?.length || 0);
      
      if (typeof cargarPropiedadesDestacadasCarousel === 'function') {
        if (propiedadesVenta && propiedadesVenta.length > 0) {
          console.log('üéØ Inicializando carrusel de venta con', propiedadesVenta.length, 'propiedades');
          cargarPropiedadesDestacadasCarousel('.featured-properties-carousel', propiedadesVenta);
        } else {
          console.warn('‚ö†Ô∏è No hay propiedades de venta para mostrar');
        }
      } else {
        console.error('‚ùå Funci√≥n cargarPropiedadesDestacadasCarousel no disponible');
      }
      
      if (typeof cargarPropiedadesDestacadasArriendoCarousel === 'function') {
        if (propiedadesArriendo && propiedadesArriendo.length > 0) {
          console.log('üéØ Inicializando carrusel de arriendo con', propiedadesArriendo.length, 'propiedades');
          cargarPropiedadesDestacadasArriendoCarousel('.featured-rental-properties-carousel', propiedadesArriendo);
        } else {
          console.warn('‚ö†Ô∏è No hay propiedades de arriendo para mostrar');
        }
      } else {
        console.error('‚ùå Funci√≥n cargarPropiedadesDestacadasArriendoCarousel no disponible');
      }
    });
  </script>
</Layout>