---
import Layout from '../layouts/Layout.astro';
import FeaturedPropertiesCarousel from '../components/FeaturedPropertiesCarousel.astro';

// Inicializamos las variables como arreglos vac√≠os por seguridad
let propiedadesVenta: any[] = [];
let propiedadesArriendo: any[] = [];

try {
  const API_URL = 'https://truthful-rhythm-e8bcafa766.strapiapp.com/api';
  const response = await fetch(`${API_URL}/propiedads?populate=*&filters[Destacado][$eq]=true&filters[Publicado][$eq]=true`);
  
  if (response.ok) {
    const responseData = await response.json();
    console.log('üì¶ Respuesta completa de Strapi:', JSON.stringify(responseData, null, 2));

    const { data: todasDestacadas } = responseData;
    console.log('üì¶ Propiedades destacadas obtenidas:', todasDestacadas?.length || 0);

    // Verificamos que 'todasDestacadas' sea un arreglo antes de filtrarlo
    if (Array.isArray(todasDestacadas)) {
      // Filtrar propiedades usando la estructura correcta (datos directos, no en attributes)
      const propiedadesVentaBruto = todasDestacadas.filter(p => {
        return p && 
               p.Objetivo === 'Venta' && 
               p.Destacado === true && 
               p.Publicado === true;
      });
      
      const propiedadesArriendoBruto = todasDestacadas.filter(p => {
        return p && 
               p.Objetivo === 'Arriendo' && 
               p.Destacado === true && 
               p.Publicado === true;
      });
      
      // Transformar datos de Strapi al formato que espera el carrusel
      propiedadesVenta = propiedadesVentaBruto.map(prop => {
        return {
          id: prop.id,
          Titulo: prop.Titulo,
          Slug: prop.Slug,
          Precio: prop.Precio,
          Ubicacion: prop.Ubicacion,
          Dormitorios: prop.Dormitorios,
          Banos: prop.Banos,
          Superficie: prop.Superficie,
          M2utiles: prop.M2utiles,
          Objetivo: prop.Objetivo,
          Destacado: prop.Destacado,
          Imagenes: prop.Imagenes?.map((img: any) => ({
            url: img.url?.startsWith('http') 
              ? img.url 
              : `https://truthful-rhythm-e8bcafa766.strapiapp.com${img.url || ''}`
          })) || []
        };
      });
      
      propiedadesArriendo = propiedadesArriendoBruto.map(prop => {
        return {
          id: prop.id,
          Titulo: prop.Titulo,
          Slug: prop.Slug,
          Precio: prop.Precio,
          Ubicacion: prop.Ubicacion,
          Dormitorios: prop.Dormitorios,
          Banos: prop.Banos,
          Superficie: prop.Superficie,
          M2utiles: prop.M2utiles,
          Objetivo: prop.Objetivo,
          Destacado: prop.Destacado,
          Imagenes: prop.Imagenes?.map((img: any) => ({
            url: img.url?.startsWith('http') 
              ? img.url 
              : `https://truthful-rhythm-e8bcafa766.strapiapp.com${img.url || ''}`
          })) || []
        };
      });
    }
  } else {
    console.error('‚ùå Error al obtener propiedades destacadas:', response.statusText);
  }
} catch (error) {
  console.error('‚ùå Error en el fetch de propiedades destacadas:', error);
}
---
<Layout
  title="PropInvest | Oportunidades Inmobiliarias"
  description="Oportunidades inmobiliarias de manera exclusiva, transparente y personalizada"
>
  {/* Este script es necesario para que los carruseles funcionen en esta p√°gina */}
  <script is:inline src="/assets/js/featured-carousel.js"></script>

  <main>
    <section class="hero">
      <div class="hero-content">
        <h1 class="hero-title">Encuentra tu oportunidad inmobiliaria</h1>
        <p class="hero-subtitle">Nosotros te asesoramos en todo el proceso</p>
        <a href="/propiedades" class="cta">Ver Propiedades</a>
      </div>
    </section>

    <section class="container" style="margin-top:3rem;">
      <div class="section-title">¬øPor qu√© elegir PropInvest?</div>
      <div class="section-subtitle">Experiencia, confianza y asesor√≠a en todo el proceso</div>
      <div style="display: flex; flex-wrap: wrap; gap:2rem; justify-content:center;">
        <div class="info-box" style="max-width:340px;">
          <div class="info-icon">
            <svg width="48" height="48" fill="none" stroke="#000000" stroke-width="1.5" viewBox="0 0 24 24">
              <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
          </div>
          <div class="info-content">
            <div class="info-title">Experiencia</div>
            <div class="info-text">M√°s de 5 a√±os asesorando a clientes</div>
          </div>
        </div>
        <div class="info-box" style="max-width:340px;">
          <div class="info-icon">
            <svg width="48" height="48" fill="none" stroke="#000000" stroke-width="1.5" viewBox="0 0 24 24">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
          </div>
          <div class="info-content">
            <div class="info-title">Confidencialidad y seguridad</div>
            <div class="info-text">Procesos totalmente transparentes</div>
          </div>
        </div>
        <div class="info-box" style="max-width:340px;">
          <div class="info-icon">
            <svg width="48" height="48" fill="none" stroke="#000000" stroke-width="1.5" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10"/>
              <path d="M2 12h20"/>
              <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
            </svg>
          </div>
          <div class="info-content">
            <div class="info-title">Equipo de trabajo</div>
            <div class="info-text">Presencia en todas las regiones para encontrar las mejores oportunidades</div>
          </div>
        </div>
      </div>
    </section>

    <FeaturedPropertiesCarousel 
      propiedadesVenta={propiedadesVenta}
      propiedadesArriendo={propiedadesArriendo}
    />

    <section class="container" style="margin-bottom:4rem;">
      <div class="section-title">Lo que dicen nuestros clientes</div>
      <div class="section-subtitle">Experiencias reales de quienes confiaron en PropInvest</div>
      <div style="display:flex; flex-wrap:wrap; gap:2.5rem; justify-content:center;">
        <div class="testimonial-card">
          <div class="testimonial-name">Mar√≠a P.</div>
          <div class="testimonial-text">"La atenci√≥n fue personalizada y el proceso, impecable. Encontr√© la inversi√≥n que estaba buscando"</div>
        </div>
        <div class="testimonial-card">
          <div class="testimonial-name">Carlos D.</div>
          <div class="testimonial-text">"PropInvest me ayud√≥ a invertir de forma segura y con total confidencialidad."</div>
        </div>
      </div>
    </section>
  </main>
</Layout>