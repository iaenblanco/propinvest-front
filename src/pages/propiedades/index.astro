---
import Layout from '../../layouts/Layout.astro';

const API_URL = 'https://truthful-rhythm-e8bcafa766.strapiapp.com/api';
const response = await fetch(`${API_URL}/propiedads?populate=*&filters[Publicado][$eq]=true`);
const { data: propiedades } = await response.json();

// CORREGIDO: Los datos vienen directamente, no en prop.attributes
const propiedadesValidas = Array.isArray(propiedades) ? propiedades.filter(prop => prop && prop.Publicado === true) : [];
---
<Layout
  title="Todas las Propiedades | PropInvest"
  description="Explora nuestra completa selección de residencias de lujo en Chile."
>
  <main>
    <section class="container" style="margin-top:3rem;">
      <div class="section-title">Todas las Propiedades</div>
      <div class="section-subtitle">Explora nuestra completa selección de residencias de lujo en Chile.</div>
      <div class="property-grid">
        {/* Usamos la lista ya filtrada y segura */}
        {propiedadesValidas.map(prop => {
          // CORREGIDO: Acceso directo a las propiedades, no prop.attributes
          const imagenUrl = prop.Imagenes?.[0]?.url?.startsWith('http') 
            ? prop.Imagenes[0].url 
            : `https://truthful-rhythm-e8bcafa766.strapiapp.com${prop.Imagenes?.[0]?.url || '/assets/images/propiedad-default.jpg'}`;
          const precioFormateado = prop.Precio 
            ? `UF ${prop.Precio.toLocaleString('es-CL')}` 
            : prop.Precio_CLP 
              ? `CLP ${prop.Precio_CLP.toLocaleString('es-CL')}` 
              : 'Consultar';

          return (
            <article class="property-card">
              <a href={`/propiedades/${prop.Slug}`} class="property-image-link">
                <img src={imagenUrl} alt={prop.Titulo} />
              </a>
              <div class="property-card-content">
                <h2 class="property-title">{prop.Titulo || 'Propiedad sin título'}</h2>
                <div class="property-location">{prop.Ubicacion || 'Sin ubicación'}</div>
                <div class="property-price">{precioFormateado}</div>
                <div class="property-features">
                  {prop.Dormitorios && <span>
                    <img src="/assets/icons/bed.svg" alt="Dormitorios" style="width:16px; height:16px; vertical-align:middle; margin-right:4px;">
                    {prop.Dormitorios}
                  </span>}
                  {prop.Banos && <span>
                    <img src="/assets/icons/shower.svg" alt="Baños" style="width:16px; height:16px; vertical-align:middle; margin-right:4px;">
                    {prop.Banos}
                  </span>}
                  {prop.Superficie && <span>
                    <img src="/assets/icons/mt2.svg" alt="Metros cuadrados" style="width:16px; height:16px; vertical-align:middle; margin-right:4px;">
                    {prop.Superficie} m²
                  </span>}
                  {prop.M2utiles && <span>
                    <img src="/assets/icons/utiles.svg" alt="Metros útiles" style="width:16px; height:16px; vertical-align:middle; margin-right:4px;">
                    {prop.M2utiles} m²
                  </span>}
                </div>
                <a href={`/propiedades/${prop.Slug}`} class="btn">Ver Propiedad</a>
              </div>
            </article>
          )
        })}
      </div>
    </section>
  </main>
</Layout>