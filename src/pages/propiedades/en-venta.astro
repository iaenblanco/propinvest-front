---
// src/pages/propiedades/en-venta.astro
import Layout from '../../layouts/Layout.astro';

const API_URL = 'https://truthful-rhythm-e8bcafa766.strapiapp.com/api';
// LA ÚNICA DIFERENCIA: Añadimos un filtro para Objetivo=Venta
const response = await fetch(`${API_URL}/propiedads?populate=*&filters[Publicado][$eq]=true&filters[Objetivo][$eq]=Venta`);
const { data: propiedades } = await response.json();

// CORREGIDO: Los datos vienen directamente, no en prop.attributes
const propiedadesValidas = Array.isArray(propiedades) ? propiedades.filter(prop => prop && prop.Objetivo === 'Venta' && prop.Publicado === true) : [];
---
<Layout
  title="Propiedades en Venta | PropInvest"
  description="Explora nuestra selección de propiedades de lujo en venta."
>
  <main>
    <section class="container" style="margin-top:3rem;">
      <div class="section-title">Propiedades en Venta</div>
      <div class="section-subtitle">Elige entre las mejores residencias de lujo en venta en Chile.</div>
      <div class="property-grid">
        {propiedadesValidas.length > 0 ? (
          propiedadesValidas.map(prop => {
            // CORREGIDO: Acceso directo a las propiedades, no prop.attributes
            const imagenUrl = prop.Imagenes?.[0]?.url?.startsWith('http') 
              ? prop.Imagenes[0].url 
              : `https://truthful-rhythm-e8bcafa766.strapiapp.com${prop.Imagenes?.[0]?.url || '/assets/images/propiedad-default.jpg'}`;
            const precioFormateado = `UF ${prop.Precio ? prop.Precio.toLocaleString('es-CL') : 'Consultar'}`;
            return (
              <article class="property-card">
                <img src={imagenUrl} alt={prop.Titulo} />
                <div class="property-card-content">
                  <h2 class="property-title">{prop.Titulo || 'Propiedad sin título'}</h2>
                  <div class="property-location">{prop.Ubicacion || 'Sin ubicación'}</div>
                  <div class="property-price">{precioFormateado}</div>
                  <div class="property-features">
                    <span>
                      <svg width="16" height="16" fill="none" stroke="#000000" stroke-width="1.5" viewBox="0 0 24 24" style="display:inline; vertical-align:middle; margin-right:4px;">
                        <path d="M3 10h18M6 10V7a3 3 0 0 1 6 0v3m-6 0v7m12-7v7m-6 0v-4a2 2 0 0 1 4 0v4"/>
                      </svg>
                      {prop.Dormitorios || 'N/A'}
                    </span>
                    <span>
                      <svg width="16" height="16" fill="none" stroke="#000000" stroke-width="1.5" viewBox="0 0 24 24" style="display:inline; vertical-align:middle; margin-right:4px;">
                        <path d="M7 10v6a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-6"/>
                        <circle cx="12" cy="7" r="3"/>
                      </svg>
                      {prop.Banos || 'N/A'}
                    </span>
                    <span>
                      <svg width="16" height="16" fill="none" stroke="#000000" stroke-width="1.5" viewBox="0 0 24 24" style="display:inline; vertical-align:middle; margin-right:4px;">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                      </svg>
                      {prop.Superficie || 'N/A'} m²
                    </span>
                  </div>
                  <a href={`/propiedades/${prop.Slug}`} class="btn">Ver Propiedad</a>
                </div>
              </article>
            )
          })
        ) : (
          <p>No hay propiedades en venta disponibles en este momento.</p>
        )}
      </div>
    </section>
  </main>
</Layout>