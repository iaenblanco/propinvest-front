---
interface Props {
  properties: any[];
  initialType?: string;
}

const { properties, initialType = '' } = Astro.props;

// Obtener tipos únicos de propiedades
const propertyTypes = [...new Set(properties.map(prop => prop.Tipo))].filter(Boolean);

// Obtener comunas únicas de propiedades
const comunas = [...new Set(properties.map(prop => prop.Comuna))].filter(Boolean).sort();

// Filtrar propiedades por tipo
const filteredProperties = initialType 
  ? properties.filter(prop => prop.Tipo === initialType)
  : properties;
---

<div class="property-type-filter">
  <div class="filter-section">
    <div class="filter-controls">
      <div class="filter-group">
        <label for="type-select" class="filter-label">
          Buscar por tipo
        </label>
        <select id="type-select" class="filter-select" aria-label="Filtrar por tipo de propiedad">
          <option value="">Todos los tipos</option>
          {propertyTypes.map((type: string) => (
            <option value={type} selected={type === initialType}>{type}</option>
          ))}
        </select>
      </div>
      
      <div class="filter-group">
        <label for="comuna-select" class="filter-label">
          Buscar por comuna
        </label>
        <select id="comuna-select" class="filter-select" aria-label="Filtrar por comuna">
          <option value="">Todas las comunas</option>
          {comunas.map((comuna: string) => (
            <option value={comuna}>{comuna}</option>
          ))}
        </select>
      </div>
    </div>
  </div>
  
  <div class="property-grid" id="filtered-properties">
    {filteredProperties.length > 0 ? (
      filteredProperties.map((prop: any) => {
        const imagenUrl = prop.Imagenes?.[0]?.url?.startsWith('http') 
          ? prop.Imagenes[0].url 
          : `https://truthful-rhythm-e8bcafa766.strapiapp.com${prop.Imagenes?.[0]?.url || '/assets/images/propiedad-default.jpg'}`;
        const precioFormateado = prop.Precio 
          ? `UF ${prop.Precio.toLocaleString('es-CL')}` 
          : prop.Precio_CLP 
            ? `$${prop.Precio_CLP.toLocaleString('es-CL')}` 
            : 'Consultar';
        return (
          <article class="featured-property-card mobile-similar-style" data-type={prop.Tipo} data-comuna={prop.Comuna}>
            <a href={`/propiedades/${prop.Slug}`} class="featured-property-image-link">
              <img src={imagenUrl} alt={prop.Titulo} class="featured-property-image" />
            </a>
            <div class="featured-property-content">
              <h2 class="featured-property-title">{prop.Titulo || 'Propiedad sin título'}</h2>
              <div class="featured-property-location">{prop.Ubicacion || 'Sin ubicación'}</div>
              <div class="featured-property-price">{precioFormateado}</div>
              <div class="featured-property-features mobile-features">
                {prop.Dormitorios && <span>
                  <img src="/assets/icons/bed.svg" alt="Dormitorios" style="width:16px; height:16px; vertical-align:middle; margin-right:4px;">
                  {prop.Dormitorios}
                </span>}
                {prop.Banos && <span>
                  <img src="/assets/icons/shower.svg" alt="Baños" style="width:16px; height:16px; vertical-align:middle; margin-right:4px;">
                  {prop.Banos}
                </span>}
                {prop.Superficie && <span>
                  <img src="/assets/icons/mt2.svg" alt="Metros cuadrados" style="width:16px; height:16px; vertical-align:middle; margin-right:4px;">
                  {prop.Superficie} m²
                </span>}
                {prop.M2utiles && <span>
                  <img src="/assets/icons/utiles.svg" alt="Metros útiles" style="width:16px; height:16px; vertical-align:middle; margin-right:4px;">
                  {prop.M2utiles} m²
                </span>}
              </div>
              <a href={`/propiedades/${prop.Slug}`} class="featured-property-btn mobile-btn">
                Ver Propiedad
              </a>
            </div>
          </article>
        )
      })
    ) : (
      <p>No hay propiedades disponibles en este momento.</p>
    )}
  </div>
</div>

<style>
  .property-type-filter {
    margin-bottom: 2rem;
  }

  .filter-section {
    margin-bottom: 2rem;
  }

  .filter-controls {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    align-items: center;
  }

  .filter-group {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    max-width: 350px;
  }

  /* Desktop: Filtros en línea */
  @media (min-width: 769px) {
    .filter-controls {
      flex-direction: row;
      justify-content: center;
      gap: 2rem;
    }

    .filter-group {
      max-width: 300px;
    }

    .filter-group:last-child .filter-select {
      min-width: 220px;
      max-width: 300px;
    }
  }

  .filter-label {
    display: flex;
    align-items: center;
    font-family: var(--font-primary);
    font-size: 1rem;
    color: var(--color-text-secondary);
    font-weight: 500;
    white-space: nowrap;
    min-width: fit-content;
  }

  .filter-select {
    background: var(--color-background);
    border: 1px solid var(--color-border);
    color: var(--color-text-secondary);
    padding: 0.75rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: var(--font-primary);
    font-size: 1rem;
    width: 100%;
    min-width: 180px;
    max-width: 250px;
  }

  .filter-select:hover {
    border-color: var(--color-primary-accent);
  }

  .filter-select:focus {
    outline: none;
    border-color: var(--color-primary-accent);
    box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
  }

  @media (max-width: 768px) {
    .filter-controls {
      gap: 1rem;
    }

    .filter-group {
      max-width: 100%;
      gap: 0.75rem;
      justify-content: flex-start;
    }

    .filter-select {
      min-width: 160px;
      max-width: 220px;
      padding: 0.6rem 0.8rem;
      font-size: 0.9rem;
      flex: 1;
    }

    .filter-label {
      font-size: 0.9rem;
      min-width: 100px;
      flex-shrink: 0;
    }
  }

  .featured-property-card {
    display: none;
  }

  .featured-property-card.visible {
    display: block;
  }
</style>

<script>
  function initializeFilter() {
    const typeSelect = document.getElementById('type-select');
    const comunaSelect = document.getElementById('comuna-select');
    const propertyGrid = document.getElementById('filtered-properties');
    const allProperties = Array.from(propertyGrid?.children || []);

    let selectedType = '';
    let selectedComuna = '';

    function applyFilters() {
      allProperties.forEach(property => {
        if (property instanceof HTMLElement) {
          const propertyType = property.getAttribute('data-type');
          const propertyComuna = property.getAttribute('data-comuna');
          
          const typeMatch = !selectedType || propertyType === selectedType;
          const comunaMatch = !selectedComuna || propertyComuna === selectedComuna;
          
          property.classList.toggle('visible', typeMatch && comunaMatch);
        }
      });

      // Actualizar layout de la grilla
      propertyGrid?.classList.remove('filtered');
      void propertyGrid?.offsetWidth;
      propertyGrid?.classList.add('filtered');
    }

    // Manejar filtro de tipo
    if (typeSelect) {
      typeSelect.addEventListener('change', () => {
        selectedType = (typeSelect as HTMLSelectElement).value;
        applyFilters();
      });
    }

    // Manejar filtro de comuna
    if (comunaSelect) {
      comunaSelect.addEventListener('change', () => {
        selectedComuna = (comunaSelect as HTMLSelectElement).value;
        applyFilters();
      });
    }

    // Mostrar todas las propiedades inicialmente
    allProperties.forEach(property => {
      if (property instanceof HTMLElement) {
        property.classList.add('visible');
      }
    });
  }

  // Inicializar cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', initializeFilter);

  // Reinicializar cuando cambie el contenido dinámicamente (para Astro View Transitions)
  document.addEventListener('astro:page-load', initializeFilter);
</script> 