<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prueba de Conexi√≥n Strapi | PropInvest</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .property-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      background: #f9f9f9;
    }
    .property-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    .property-details {
      color: #666;
      font-size: 14px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Prueba de Conexi√≥n con Strapi</h1>
    <p>Esta p√°gina te permite verificar que la conexi√≥n con tu backend de Strapi funcione correctamente.</p>
    
    <div id="status-container">
      <div class="status info">
        <strong>Estado:</strong> Esperando conexi√≥n...
      </div>
    </div>
    
    <div style="margin: 20px 0;">
      <button onclick="testConnection()">üîó Probar Conexi√≥n</button>
      <button onclick="loadAllProperties()">üìã Cargar Todas las Propiedades</button>
      <button onclick="loadFeaturedProperties()">‚≠ê Cargar Propiedades Destacadas</button>
    </div>
    
    <div id="results">
      <div class="loading">Haz clic en "Probar Conexi√≥n" para comenzar</div>
    </div>
  </div>

  <!-- Scripts necesarios -->
  <script src="/assets/js/config.js"></script>
  <script src="/assets/js/api.js"></script>
  
  <script>
    const api = new StrapiAPI();
    const statusContainer = document.getElementById('status-container');
    const resultsContainer = document.getElementById('results');

    function updateStatus(message, type = 'info') {
      statusContainer.innerHTML = `
        <div class="status ${type}">
          <strong>Estado:</strong> ${message}
        </div>
      `;
    }

    function showResults(content) {
      resultsContainer.innerHTML = content;
    }

    async function testConnection() {
      updateStatus('Probando conexi√≥n con Strapi...', 'info');
      
      try {
        const response = await api.fetchAPI('/propiedads?pagination[limit]=1');
        
        if (response && response.data !== undefined) {
          updateStatus(`‚úÖ Conexi√≥n exitosa! Se encontraron ${response.meta?.pagination?.total || 'N/A'} propiedades`, 'success');
          showResults(`
            <div class="property-card">
              <div class="property-title">‚úÖ Conexi√≥n establecida correctamente</div>
              <div class="property-details">
                <strong>URL de la API:</strong> ${STRAPI_CONFIG.API_BASE_URL}<br>
                <strong>Total de propiedades:</strong> ${response.meta?.pagination?.total || 'N/A'}<br>
                <strong>Propiedades por p√°gina:</strong> ${response.meta?.pagination?.pageSize || 'N/A'}
              </div>
            </div>
          `);
        } else {
          throw new Error('Respuesta inesperada de la API');
        }
      } catch (error) {
        updateStatus(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
        showResults(`
          <div class="property-card">
            <div class="property-title">‚ùå Error de conexi√≥n</div>
            <div class="property-details">
              <strong>Error:</strong> ${error.message}<br>
              <strong>URL probada:</strong> ${STRAPI_CONFIG.API_BASE_URL}/propiedads<br>
              <br>
              <strong>Posibles soluciones:</strong><br>
              1. Verifica que Strapi est√© funcionando<br>
              2. Confirma que la colecci√≥n "Propiedad" exista<br>
              3. Revisa los permisos de la colecci√≥n<br>
              4. Verifica la configuraci√≥n de CORS
            </div>
          </div>
        `);
      }
    }

    async function loadAllProperties() {
      updateStatus('Cargando todas las propiedades...', 'info');
      
      try {
        const propiedades = await api.getPropiedades();
        
        if (propiedades.length === 0) {
          updateStatus('‚ÑπÔ∏è No se encontraron propiedades publicadas', 'info');
          showResults(`
            <div class="property-card">
              <div class="property-title">‚ÑπÔ∏è No hay propiedades</div>
              <div class="property-details">
                No se encontraron propiedades con <code>publicado: true</code><br>
                Verifica que tengas propiedades creadas y marcadas como publicadas en Strapi.
              </div>
            </div>
          `);
          return;
        }
        
        updateStatus(`‚úÖ Se cargaron ${propiedades.length} propiedades`, 'success');
        
        const propertiesHTML = propiedades.map(prop => {
          const attrs = prop.attributes;
          return `
            <div class="property-card">
              <div class="property-title">${attrs.Titulo || 'Sin t√≠tulo'}</div>
              <div class="property-details">
                <strong>Slug:</strong> ${attrs.Slug || 'Sin slug'}<br>
                <strong>Ubicaci√≥n:</strong> ${attrs.Ubicacion || 'Sin ubicaci√≥n'}<br>
                <strong>Precio:</strong> ${formatearPrecio(attrs.Precio)}<br>
                <strong>Dormitorios:</strong> ${attrs.Dormitorios || 'N/A'}<br>
                <strong>Ba√±os:</strong> ${attrs.Banos || 'N/A'}<br>
                <strong>Superficie:</strong> ${attrs.Superficie || 'N/A'} m¬≤<br>
                <strong>Destacado:</strong> ${attrs.Destacado ? '‚úÖ S√≠' : '‚ùå No'}<br>
                <strong>Publicado:</strong> ${attrs.Publicado ? '‚úÖ S√≠' : '‚ùå No'}<br>
                <strong>Im√°genes:</strong> ${attrs.Imagenes?.data?.length || 0} imagen(es)
              </div>
            </div>
          `;
        }).join('');
        
        showResults(propertiesHTML);
        
      } catch (error) {
        updateStatus(`‚ùå Error al cargar propiedades: ${error.message}`, 'error');
        showResults(`
          <div class="property-card">
            <div class="property-title">‚ùå Error al cargar propiedades</div>
            <div class="property-details">
              <strong>Error:</strong> ${error.message}
            </div>
          </div>
        `);
      }
    }

    async function loadFeaturedProperties() {
      updateStatus('Cargando propiedades destacadas...', 'info');
      
      try {
        const propiedades = await api.getPropiedadesDestacadas();
        
        if (propiedades.length === 0) {
          updateStatus('‚ÑπÔ∏è No se encontraron propiedades destacadas', 'info');
          showResults(`
            <div class="property-card">
              <div class="property-title">‚ÑπÔ∏è No hay propiedades destacadas</div>
              <div class="property-details">
                No se encontraron propiedades con <code>destacado: true</code> y <code>publicado: true</code><br>
                Verifica que tengas propiedades marcadas como destacadas en Strapi.
              </div>
            </div>
          `);
          return;
        }
        
        updateStatus(`‚úÖ Se cargaron ${propiedades.length} propiedades destacadas`, 'success');
        
        const propertiesHTML = propiedades.map(prop => {
          const attrs = prop.attributes;
          return `
            <div class="property-card">
              <div class="property-title">${attrs.Titulo || 'Sin t√≠tulo'}</div>
              <div class="property-details">
                <strong>Slug:</strong> ${attrs.Slug || 'Sin slug'}<br>
                <strong>Ubicaci√≥n:</strong> ${attrs.Ubicacion || 'Sin ubicaci√≥n'}<br>
                <strong>Precio:</strong> ${formatearPrecio(attrs.Precio)}<br>
                <strong>Dormitorios:</strong> ${attrs.Dormitorios || 'N/A'}<br>
                <strong>Ba√±os:</strong> ${attrs.Banos || 'N/A'}<br>
                <strong>Superficie:</strong> ${attrs.Superficie || 'N/A'} m¬≤<br>
                <strong>Im√°genes:</strong> ${attrs.Imagenes?.data?.length || 0} imagen(es)
              </div>
            </div>
          `;
        }).join('');
        
        showResults(propertiesHTML);
        
      } catch (error) {
        updateStatus(`‚ùå Error al cargar propiedades destacadas: ${error.message}`, 'error');
        showResults(`
          <div class="property-card">
            <div class="property-title">‚ùå Error al cargar propiedades destacadas</div>
            <div class="property-details">
              <strong>Error:</strong> ${error.message}
            </div>
          </div>
        `);
      }
    }

    // Auto-probar conexi√≥n al cargar la p√°gina
    window.addEventListener('load', () => {
      setTimeout(testConnection, 1000);
    });
  </script>
</body>
</html> 